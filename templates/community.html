{% extends 'base.html' %}

{% block content %}
<div class="container py-4 text-white h-100">
    <div class="row justify-content-center h-100">
        <div class="col-lg-8 col-md-10">
            
            <div class="text-center mb-4">
                <h2 class="fw-bold"><i class="fa-solid fa-users text-info"></i> Student <span class="text-warning">Lounge</span></h2>
                <p class="opacity-75">Connect, discuss, and grow with other students!</p>
            </div>

            <div class="glass-card d-flex flex-column" style="height: 65vh;">
                
                <div id="chat-box" class="flex-grow-1 p-3" style="overflow-y: auto; scrollbar-width: thin;">
                    <div class="text-center text-white-50 mt-5">Loading messages...</div>
                </div>

                <div class="p-3 border-top border-secondary bg-dark bg-opacity-25">
                    <div class="input-group">
                        <input type="text" id="msgInput" class="form-control border-0 text-white" 
                               placeholder="Type a message..." style="background: rgba(255,255,255,0.1);"
                               onkeypress="handleEnter(event)">
                        <button class="btn btn-info px-4" onclick="sendMessage()">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const currentUser = "{{ user.username }}";
    const chatBox = document.getElementById('chat-box');

    // 1. Load Messages (Polling every 2 seconds)
    async function loadMessages() {
        try {
            const res = await fetch('/api/messages');
            const msgs = await res.json();
            
            chatBox.innerHTML = ''; // Clear old
            
            msgs.forEach(msg => {
                const isMe = msg.username === currentUser;
                const div = document.createElement('div');
                div.className = `d-flex flex-row justify-content-${isMe ? 'end' : 'start'} mb-2`;
                div.innerHTML = `
                    <div class="p-2 px-3 rounded-3 shadow-sm" 
                         style="background: ${isMe ? '#4e54c8' : 'rgba(255,255,255,0.1)'}; max-width: 75%;">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold small ${isMe ? 'text-warning' : 'text-info'}" style="font-size: 0.8rem;">${msg.username}</span>
                        </div>
                        <span class="text-white">${msg.content}</span>
                        <div class="text-end mt-1"><small class="text-white-50" style="font-size: 0.7rem;">${msg.time}</small></div>
                    </div>
                `;
                chatBox.appendChild(div);
            });
            
            // Auto scroll only if near bottom (optional, basic logic here)
            // chatBox.scrollTop = chatBox.scrollHeight; 
        } catch (e) { console.error("Chat error", e); }
    }

    // First load
    loadMessages();
    // Refresh every 2 seconds
    setInterval(loadMessages, 2000);

    // 2. Send Message
    async function sendMessage() {
        const input = document.getElementById('msgInput');
        const content = input.value.trim();
        if(!content) return;

        input.value = ''; // Clear input immediately
        
        await fetch('/api/messages', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: content})
        });
        
        loadMessages(); // Instant refresh
    }

    function handleEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}