{% extends 'base.html' %}

{% block content %}

<style>

.community-page {
    background:
        radial-gradient(circle at 15% 20%, rgba(255, 221, 153, 0.7), transparent 40%),
        radial-gradient(circle at 85% 80%, rgba(255, 183, 77, 0.6), transparent 40%),
        linear-gradient(135deg, #fff7e6, #ffe0b2);
    min-height: calc(100vh - 90px);
    padding: 40px 15px;
}


.community-title {
    font-weight: 800;
    color: #111827;
}

.community-title span {
    background: linear-gradient(135deg, #ff512f, #f09819);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.community-subtitle {
    color: #374151;
}


.chat-card {
    background: rgba(255, 255, 255, 0.96);
    border-radius: 28px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.15);
    height: 65vh;
    display: flex;
    flex-direction: column;
}


#chat-box {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
}


.msg-me {
    background: linear-gradient(135deg, #ffb703, #ffd166);
    color: #111827; 
    border-radius: 18px;
    padding: 10px 14px;
    max-width: 75%;
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.msg-other {
    background: #ffffff;
    color: #111827;
    border-radius: 18px;
    padding: 10px 14px;
    max-width: 75%;
    border: 1px solid #fde68a;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}


.msg-user {
    font-size: 0.75rem;
    font-weight: 600;
    color: #92400e;   
}

.msg-time {
    font-size: 0.7rem;
    color: #78350f;
}


.chat-input {
    padding: 15px;
    border-top: 1px solid #fde68a;
    background: #fffaf0;
    border-radius: 0 0 28px 28px;
}

#msgInput {
    border-radius: 16px;
    padding: 12px;
}


.btn-send {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    color: white;
    font-weight: 600;
}

.btn-send:hover {
    transform: translateY(-2px);
}
</style>

<div class="community-page">
    <div class="container">

        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">

                
                <div class="text-center mb-4">
                    <h2 class="community-title">
                        <i class="fa-solid fa-users me-2 text-success"></i>
                        Student <span>Lounge</span>
                    </h2>
                    <p class="community-subtitle">
                        Connect, discuss, and grow with other students!
                    </p>
                </div>

                
                <div class="chat-card">

                    
                    <div id="chat-box">
                        <div class="text-center text-muted mt-5">
                            Loading messages...
                        </div>
                    </div>

                    <div class="chat-input">
                        <div class="input-group">
                            <input
                                type="text"
                                id="msgInput"
                                class="form-control"
                                placeholder="Type a message..."
                                onkeypress="handleEnter(event)"
                            >
                            <button class="btn btn-send px-4" onclick="sendMessage()">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>
</div>

<script>
const currentUser = "{{ user.username }}";
const chatBox = document.getElementById('chat-box');

async function loadMessages() {
    try {
        const res = await fetch('/api/messages');
        const msgs = await res.json();

        chatBox.innerHTML = '';

        msgs.forEach(msg => {
            const isMe = msg.username === currentUser;
            const wrapper = document.createElement('div');
            wrapper.className = `d-flex justify-content-${isMe ? 'end' : 'start'} mb-3`;

            wrapper.innerHTML = `
                <div class="${isMe ? 'msg-me' : 'msg-other'}">
                    <div class="msg-user">${msg.username}</div>
                    <div>${msg.content}</div>
                    <div class="text-end msg-time">${msg.time}</div>
                </div>
            `;
            chatBox.appendChild(wrapper);
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    } catch (e) {
        console.error("Chat error", e);
    }
}

loadMessages();
setInterval(loadMessages, 2000);

async function sendMessage() {
    const input = document.getElementById('msgInput');
    const content = input.value.trim();
    if (!content) return;

    input.value = '';

    await fetch('/api/messages', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content})
    });

    loadMessages();
}

function handleEnter(e) {
    if (e.key === 'Enter') sendMessage();
}
</script>

{% endblock %}
