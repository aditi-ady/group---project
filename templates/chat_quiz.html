{% extends 'base.html' %}

{% block content %}

<div class="container py-5">
    <div class="text-center mb-4">
        <h2 class="fw-bold" style="font-size: 2.6rem; color:#111827;">
            AI <span style="background: linear-gradient(135deg, #f59e0b, #fb7185); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Tutor</span>
        </h2>
        <p class="d-inline-block px-3 py-2 rounded-pill shadow-sm bg-white text-secondary">
            Type <b>‚ÄúQuiz me on Python‚Äù</b> to start a test!
        </p>
    </div>

    <div class="glass-card d-flex flex-column mx-auto" style="max-width: 720px; height: 65vh;">
        
        <div id="chat-box" class="flex-grow-1 p-3" style="overflow-y:auto; background:#ffffff; border-radius:18px;">
            <div class="d-flex justify-content-start mb-3">
                <div class="chat-bubble ai">
                    <div class="chat-user">AI Tutor</div>
                    <div class="chat-text">Hello! üëã Ask me a doubt or say <b>"Take a quiz on [Topic]"</b>.</div>
                </div>
            </div>
        </div>

        <div class="p-3 border-top">
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Type message..." onkeypress="handleEnter(event)">
                <button class="btn btn-primary px-4" onclick="sendMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
let currentSubject = "General"; 


function appendMessage(type, sender, content) {
    const wrap = document.createElement("div");
    wrap.className = `d-flex mb-3 ${type === 'user' ? 'justify-content-end' : 'justify-content-start'}`;
    
    
    wrap.innerHTML = `
        <div class="chat-bubble ${type}">
            <div class="chat-user">${sender}</div>
            <div class="chat-text">${content}</div>
        </div>
    `;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
}


async function sendMessage() {
    const input = document.getElementById("user-input");
    const msg = input.value.trim();
    if (!msg) return;

    input.value = "";
    appendMessage("user", "You", msg);

    
    const loadingId = "loading-" + Date.now();
    appendMessage("ai", "AI Tutor", `<span id="${loadingId}">Thinking... <i class="fa-solid fa-spinner fa-spin"></i></span>`);

    try {
        const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: msg })
        });

        const data = await res.json();
        
        
        document.getElementById(loadingId).parentElement.parentElement.remove();

        
        if (data.type === 'quiz') {
            renderQuiz(data);
        } else {
            appendMessage("ai", "AI Tutor", data.reply);
        }

    } catch (err) {
        console.error(err);
        document.getElementById(loadingId).innerText = "Error connecting to AI.";
    }
}


function renderQuiz(data) {
    currentSubject = data.subject || "General";
    let quizHtml = `<div class="mb-2"><strong>Topic: ${data.subject}</strong></div>`;
    
    data.questions.forEach((q, index) => {
        quizHtml += `
            <div class="mb-4 p-3 border rounded bg-white shadow-sm">
                <p class="mb-2 fw-bold">Q${index + 1}: ${q.question}</p>
                <div class="d-grid gap-2">
                    ${q.options.map(opt => 
                        `<button class="btn btn-outline-primary text-start" 
                                 onclick="checkAnswer(this, '${opt}', '${q.correct}')">
                            ${opt}
                         </button>`
                    ).join('')}
                </div>
                <div class="mt-2 result-msg fw-bold"></div>
            </div>
        `;
    });
    
    appendMessage("ai", "AI Tutor", quizHtml);
}


function checkAnswer(btn, selected, correct) {
    const parent = btn.parentElement;
    const resultDiv = parent.nextElementSibling;
    
  
    const allBtns = parent.querySelectorAll('button');
    allBtns.forEach(b => b.disabled = true);

    const isCorrect = (selected === correct);

    if (isCorrect) {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        resultDiv.innerHTML = `<span class="text-success">Correct! üéâ</span>`;
    } else {
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-danger');
        resultDiv.innerHTML = `<span class="text-danger">Wrong! Correct was: ${correct}</span>`;
    }

    
    fetch('/api/update_quiz_stats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correct: isCorrect, subject: currentSubject })
    });
}

function handleEnter(e) {
    if (e.key === "Enter") sendMessage();
}
</script>

<style>

.chat-bubble { max-width: 85%; padding: 14px 18px; border-radius: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); animation: fadeIn 0.3s ease; }
.chat-bubble.user { background: linear-gradient(135deg, #ffedd5, #fde68a); color: #111827; }
.chat-bubble.ai { background: #f3f4f6; color: #111827; }
.chat-user { font-size: 0.75rem; font-weight: 600; color: #6b7280; margin-bottom: 4px; }
.chat-text { font-size: 0.95rem; line-height: 1.5; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

{% endblock %}
